import{d as rt,r as n,l as K,m as ut,o as pt,c as u,a as e,f as E,b as d,i as c,e as o,j as vt,t as m,F as P,p as _,h as U,x as ct,n as W,w as z,g as p,A as b,B as mt,z as h,y as bt,k as i}from"./index-FuMGBNr_.js";import{A as ft}from"./arrow-left-CzJQ-YTU.js";import{T as O}from"./triangle-alert-1Rn6Vmyi.js";import{S as gt}from"./server-CbUF9Ud5.js";import{S as q}from"./square-pen-DfF-Q1Qq.js";import{K as yt,W as xt,a as _t}from"./wifi-Bi-8Pd7i.js";import{F as kt}from"./file-key-CKcbrZKU.js";import{P as wt,T as Ct}from"./trash-2-C3yPm7fe.js";import{X as A}from"./x-CSfYnYOr.js";import{S as X}from"./save-sGnfBaPx.js";import{C as ht}from"./check-Ib64XTCh.js";import{C as $t}from"./copy-CDy7s6v3.js";import{c as G}from"./createLucideIcon-DPGb8pea.js";const Vt=G("folder-open",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]);const Ut=G("terminal",[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]]),At={class:"space-y-4"},Dt={key:0,class:"flex justify-center py-12"},St={key:1,class:"alert alert-error"},Mt={class:"card bg-base-100 shadow-sm"},Tt={class:"card-body"},Ft={class:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4"},Et={class:"flex items-center gap-3"},It={class:"w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center"},jt={class:"text-xl font-bold"},Nt={class:"flex gap-2"},Bt=["disabled"],Rt={class:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"},Lt={class:"font-mono"},Pt={class:"card bg-base-100 shadow-sm"},zt={class:"card-body"},Ht={class:"flex items-center justify-between mb-4"},Kt={class:"card-title text-lg"},Wt={key:0,class:"text-center py-8 text-base-content/60"},Ot={key:1,class:"space-y-3"},qt={class:"flex flex-col lg:flex-row lg:items-center justify-between gap-3"},Xt={class:"flex-1"},Gt={class:"font-medium"},Jt={class:"flex flex-wrap gap-x-4 gap-y-1 text-sm text-base-content/60 mt-1"},Qt={class:"flex items-center gap-1"},Yt={class:"flex items-center gap-1"},Zt={class:"flex gap-2"},te=["onClick"],ee=["onClick"],le={class:"modal-box"},se={class:"form-control"},ae={class:"form-control"},oe={class:"modal-action"},ne=["disabled"],ie={key:0,class:"loading loading-spinner loading-sm"},de={method:"dialog",class:"modal-backdrop"},re={class:"modal-box"},ue={class:"alert alert-warning mb-4"},pe={class:"form-control"},ve={class:"flex gap-2"},ce=["value"],me={class:"modal-action"},be={method:"dialog",class:"modal-backdrop"},fe={class:"modal-box max-w-lg"},ge={key:0,class:"alert alert-error text-sm"},ye={class:"form-control"},xe=["value"],_e={class:"form-control"},ke={class:"grid grid-cols-1 sm:grid-cols-3 gap-2"},we={class:"form-control"},Ce={class:"form-control"},he={class:"form-control"},$e={class:"form-control"},Ve={class:"modal-action"},Ue=["disabled"],Ae={key:0,class:"loading loading-spinner loading-sm"},De={method:"dialog",class:"modal-backdrop"},Se={class:"modal-box max-w-lg"},Me={class:"form-control"},Te={class:"grid grid-cols-1 sm:grid-cols-3 gap-2"},Fe={class:"form-control"},Ee={class:"form-control"},Ie={class:"form-control"},je={class:"form-control"},Ne={class:"modal-action"},Be=["disabled"],Re={key:0,class:"loading loading-spinner loading-sm"},Le={method:"dialog",class:"modal-backdrop"},Pe={class:"modal-box"},ze={class:"modal-action"},He=["disabled"],Ke={key:0,class:"loading loading-spinner loading-sm"},We={method:"dialog",class:"modal-backdrop"},nl=rt({__name:"AgentDetail",setup(Oe){const J=ut(),Q=vt(),s=n(null),I=n([]),j=n(!0),f=n(""),x=n(!1),k=n({name:"",poll_interval:300}),D=n(!1),S=n(!1),$=n(!1),N=n(""),B=n(!1),w=n(!1),r=n({cert_id:0,deploy_path:"/etc/ssl/certs",file_mapping:{cert:"cert.pem",key:"key.pem",fullchain:"fullchain.pem"},reload_cmd:"systemctl reload nginx"}),M=n(!1),V=n(""),g=n(null),v=n({deploy_path:"",file_mapping:{cert:"",key:"",fullchain:""},reload_cmd:""}),T=n(!1),y=n(null),F=n(!1),Y=K(()=>Number(J.params.id));async function C(){j.value=!0,f.value="";try{const[a,t]=await Promise.all([h.get(Y.value),bt.list()]);s.value=a.data,I.value=t.data||[]}catch(a){const t=a;t.response?.status===404?f.value="Agent 不存在":f.value=t.message||"加载失败"}finally{j.value=!1}}function H(a){return a?new Date(a).toLocaleString("zh-CN"):"-"}function R(a,t){const l=Date.now(),L=t?new Date(t).getTime():0,dt=l-L;return a==="online"||dt<300*1e3?{icon:xt,class:"text-success",text:"在线"}:{icon:_t,class:"text-error",text:"离线"}}function Z(){s.value&&(k.value={name:s.value.name,poll_interval:s.value.poll_interval},x.value=!0)}async function tt(){if(s.value){D.value=!0;try{await h.update(s.value.id,k.value),x.value=!1,await C()}catch(a){const t=a;f.value=t.response?.data?.error?.message||"保存失败",x.value=!1}finally{D.value=!1}}}async function et(){if(s.value){S.value=!0;try{const{data:a}=await h.regenerate(s.value.id);N.value=a.connect_url||`${window.location.origin}/agent/${s.value.uuid}/${a.signature}`,$.value=!0,await C()}catch(a){const t=a;f.value=t.response?.data?.error?.message||"重置密钥失败"}finally{S.value=!1}}}function lt(){navigator.clipboard.writeText(N.value),B.value=!0,setTimeout(()=>{B.value=!1},2e3)}async function st(){if(s.value){if(V.value="",!r.value.cert_id){V.value="请选择证书";return}M.value=!0;try{await h.addCert(s.value.id,r.value),w.value=!1,r.value={cert_id:0,deploy_path:"/etc/ssl/certs",file_mapping:{cert:"cert.pem",key:"key.pem",fullchain:"fullchain.pem"},reload_cmd:"systemctl reload nginx"},await C()}catch(a){const t=a;V.value=t.response?.data?.error?.message||"添加失败"}finally{M.value=!1}}}function at(a){g.value=a.id,v.value={deploy_path:a.deploy_path,file_mapping:{...a.file_mapping},reload_cmd:a.reload_cmd}}async function ot(){if(!(!s.value||!g.value)){T.value=!0;try{await h.updateCert(s.value.id,g.value,v.value),g.value=null,await C()}catch(a){const t=a;f.value=t.response?.data?.error?.message||"保存失败",g.value=null}finally{T.value=!1}}}async function nt(){if(!(!s.value||!y.value)){F.value=!0;try{await h.deleteCert(s.value.id,y.value),y.value=null,await C()}catch(a){const t=a;f.value=t.response?.data?.error?.message||"删除失败",y.value=null}finally{F.value=!1}}}const it=K(()=>{if(!s.value)return I.value;const a=s.value.certs?.map(t=>t.cert_id)||[];return I.value.filter(t=>!a.includes(t.id))});return pt(C),(a,t)=>(i(),u("div",At,[e("button",{class:"btn btn-ghost btn-sm gap-2",onClick:t[0]||(t[0]=l=>o(Q).push("/agents"))},[d(o(ft),{class:"w-4 h-4"}),t[30]||(t[30]=c(" 返回列表 ",-1))]),j.value?(i(),u("div",Dt,[...t[31]||(t[31]=[e("span",{class:"loading loading-spinner loading-lg"},null,-1)])])):f.value?(i(),u("div",St,[d(o(O),{class:"w-5 h-5"}),e("span",null,m(f.value),1)])):s.value?(i(),u(P,{key:2},[e("div",Mt,[e("div",Tt,[e("div",Ft,[e("div",Et,[e("div",It,[d(o(gt),{class:"w-6 h-6 text-primary"})]),e("div",null,[e("h2",jt,m(s.value.name),1),e("div",{class:_(["flex items-center gap-1 text-sm",R(s.value.status,s.value.last_seen).class])},[(i(),U(ct(R(s.value.status,s.value.last_seen).icon),{class:"w-4 h-4"})),c(" "+m(R(s.value.status,s.value.last_seen).text),1)],2)])]),e("div",Nt,[e("button",{class:"btn btn-outline btn-sm",onClick:Z},[d(o(q),{class:"w-4 h-4"}),t[32]||(t[32]=c(" 编辑 ",-1))]),e("button",{class:"btn btn-outline btn-sm",disabled:S.value,onClick:et},[d(o(yt),{class:_(["w-4 h-4",S.value&&"animate-spin"])},null,8,["class"]),t[33]||(t[33]=c(" 重置密钥 ",-1))],8,Bt)])]),e("div",Rt,[e("div",null,[t[34]||(t[34]=e("p",{class:"text-base-content/60"},"UUID",-1)),e("p",Lt,m(s.value.uuid),1)]),e("div",null,[t[35]||(t[35]=e("p",{class:"text-base-content/60"},"轮询间隔",-1)),e("p",null,m(s.value.poll_interval)+" 秒",1)]),e("div",null,[t[36]||(t[36]=e("p",{class:"text-base-content/60"},"最后上线",-1)),e("p",null,m(H(s.value.last_seen)),1)]),e("div",null,[t[37]||(t[37]=e("p",{class:"text-base-content/60"},"创建时间",-1)),e("p",null,m(H(s.value.created_at)),1)])])])]),e("div",Pt,[e("div",zt,[e("div",Ht,[e("h3",Kt,[d(o(kt),{class:"w-5 h-5"}),t[38]||(t[38]=c(" 证书绑定 ",-1))]),e("button",{class:"btn btn-primary btn-sm",onClick:t[1]||(t[1]=l=>w.value=!0)},[d(o(wt),{class:"w-4 h-4"}),t[39]||(t[39]=c(" 添加 ",-1))])]),!s.value.certs||s.value.certs.length===0?(i(),u("div",Wt," 暂无绑定的证书 ")):(i(),u("div",Ot,[(i(!0),u(P,null,W(s.value.certs,l=>(i(),u("div",{key:l.id,class:"border border-base-200 rounded-lg p-4"},[e("div",qt,[e("div",Xt,[e("p",Gt,m(l.domain||`证书 #${l.cert_id}`),1),e("div",Jt,[e("span",Qt,[d(o(Vt),{class:"w-4 h-4"}),c(" "+m(l.deploy_path),1)]),e("span",Yt,[d(o(Ut),{class:"w-4 h-4"}),c(" "+m(l.reload_cmd),1)])])]),e("div",Zt,[e("button",{class:"btn btn-ghost btn-xs",onClick:L=>at(l)},[d(o(q),{class:"w-4 h-4"})],8,te),e("button",{class:"btn btn-ghost btn-xs text-error",onClick:L=>y.value=l.id},[d(o(Ct),{class:"w-4 h-4"})],8,ee)])])]))),128))]))])])],64)):E("",!0),e("dialog",{class:_(["modal",x.value&&"modal-open"])},[e("div",le,[e("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:t[2]||(t[2]=l=>x.value=!1)},[d(o(A),{class:"w-4 h-4"})]),t[43]||(t[43]=e("h3",{class:"font-bold text-lg mb-4"},"编辑 Agent",-1)),e("form",{onSubmit:z(tt,["prevent"]),class:"space-y-4"},[e("div",se,[t[40]||(t[40]=e("label",{class:"label"},[e("span",{class:"label-text"},"名称")],-1)),p(e("input",{"onUpdate:modelValue":t[3]||(t[3]=l=>k.value.name=l),type:"text",class:"input input-bordered"},null,512),[[b,k.value.name]])]),e("div",ae,[t[41]||(t[41]=e("label",{class:"label"},[e("span",{class:"label-text"},"轮询间隔 (秒)")],-1)),p(e("input",{"onUpdate:modelValue":t[4]||(t[4]=l=>k.value.poll_interval=l),type:"number",class:"input input-bordered",min:"60"},null,512),[[b,k.value.poll_interval,void 0,{number:!0}]])]),e("div",oe,[e("button",{type:"button",class:"btn",onClick:t[5]||(t[5]=l=>x.value=!1)},"取消"),e("button",{type:"submit",class:"btn btn-primary",disabled:D.value},[D.value?(i(),u("span",ie)):(i(),U(o(X),{key:1,class:"w-4 h-4"})),t[42]||(t[42]=c(" 保存 ",-1))],8,ne)])],32)]),e("form",de,[e("button",{onClick:t[6]||(t[6]=l=>x.value=!1)},"close")])],2),e("dialog",{class:_(["modal",$.value&&"modal-open"])},[e("div",re,[e("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:t[7]||(t[7]=l=>$.value=!1)},[d(o(A),{class:"w-4 h-4"})]),t[45]||(t[45]=e("h3",{class:"font-bold text-lg mb-4"},"新连接信息",-1)),e("div",ue,[d(o(O),{class:"w-5 h-5"}),t[44]||(t[44]=e("span",null,"密钥已重置，请更新 Agent 配置！",-1))]),e("div",pe,[e("div",ve,[e("input",{value:N.value,type:"text",class:"input input-bordered flex-1 font-mono text-xs",readonly:""},null,8,ce),e("button",{class:"btn btn-ghost",onClick:lt},[B.value?(i(),U(o(ht),{key:0,class:"w-5 h-5 text-success"})):(i(),U(o($t),{key:1,class:"w-5 h-5"}))])])]),e("div",me,[e("button",{class:"btn btn-primary",onClick:t[8]||(t[8]=l=>$.value=!1)},"确定")])]),e("form",be,[e("button",{onClick:t[9]||(t[9]=l=>$.value=!1)},"close")])],2),e("dialog",{class:_(["modal",w.value&&"modal-open"])},[e("div",fe,[e("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:t[10]||(t[10]=l=>w.value=!1)},[d(o(A),{class:"w-4 h-4"})]),t[54]||(t[54]=e("h3",{class:"font-bold text-lg mb-4"},"添加证书绑定",-1)),e("form",{onSubmit:z(st,["prevent"]),class:"space-y-4"},[V.value?(i(),u("div",ge,m(V.value),1)):E("",!0),e("div",ye,[t[47]||(t[47]=e("label",{class:"label"},[e("span",{class:"label-text"},"选择证书 *")],-1)),p(e("select",{"onUpdate:modelValue":t[11]||(t[11]=l=>r.value.cert_id=l),class:"select select-bordered w-full"},[t[46]||(t[46]=e("option",{value:0,disabled:""},"请选择",-1)),(i(!0),u(P,null,W(it.value,l=>(i(),u("option",{key:l.id,value:l.id},m(l.domain),9,xe))),128))],512),[[mt,r.value.cert_id]])]),e("div",_e,[t[48]||(t[48]=e("label",{class:"label"},[e("span",{class:"label-text"},"部署路径")],-1)),p(e("input",{"onUpdate:modelValue":t[12]||(t[12]=l=>r.value.deploy_path=l),type:"text",class:"input input-bordered w-full",placeholder:"/etc/ssl/certs"},null,512),[[b,r.value.deploy_path]])]),e("div",ke,[e("div",we,[t[49]||(t[49]=e("label",{class:"label"},[e("span",{class:"label-text text-sm"},"证书文件名")],-1)),p(e("input",{"onUpdate:modelValue":t[13]||(t[13]=l=>r.value.file_mapping.cert=l),type:"text",class:"input input-bordered input-sm"},null,512),[[b,r.value.file_mapping.cert]])]),e("div",Ce,[t[50]||(t[50]=e("label",{class:"label"},[e("span",{class:"label-text text-sm"},"私钥文件名")],-1)),p(e("input",{"onUpdate:modelValue":t[14]||(t[14]=l=>r.value.file_mapping.key=l),type:"text",class:"input input-bordered input-sm"},null,512),[[b,r.value.file_mapping.key]])]),e("div",he,[t[51]||(t[51]=e("label",{class:"label"},[e("span",{class:"label-text text-sm"},"完整链文件名")],-1)),p(e("input",{"onUpdate:modelValue":t[15]||(t[15]=l=>r.value.file_mapping.fullchain=l),type:"text",class:"input input-bordered input-sm"},null,512),[[b,r.value.file_mapping.fullchain]])])]),e("div",$e,[t[52]||(t[52]=e("label",{class:"label"},[e("span",{class:"label-text"},"重载命令")],-1)),p(e("input",{"onUpdate:modelValue":t[16]||(t[16]=l=>r.value.reload_cmd=l),type:"text",class:"input input-bordered w-full",placeholder:"systemctl reload nginx"},null,512),[[b,r.value.reload_cmd]])]),e("div",Ve,[e("button",{type:"button",class:"btn",onClick:t[17]||(t[17]=l=>w.value=!1)},"取消"),e("button",{type:"submit",class:"btn btn-primary",disabled:M.value},[M.value?(i(),u("span",Ae)):E("",!0),t[53]||(t[53]=c(" 添加 ",-1))],8,Ue)])],32)]),e("form",De,[e("button",{onClick:t[18]||(t[18]=l=>w.value=!1)},"close")])],2),e("dialog",{class:_(["modal",g.value!==null&&"modal-open"])},[e("div",Se,[e("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:t[19]||(t[19]=l=>g.value=null)},[d(o(A),{class:"w-4 h-4"})]),t[61]||(t[61]=e("h3",{class:"font-bold text-lg mb-4"},"编辑证书绑定",-1)),e("form",{onSubmit:z(ot,["prevent"]),class:"space-y-4"},[e("div",Me,[t[55]||(t[55]=e("label",{class:"label"},[e("span",{class:"label-text"},"部署路径")],-1)),p(e("input",{"onUpdate:modelValue":t[20]||(t[20]=l=>v.value.deploy_path=l),type:"text",class:"input input-bordered w-full"},null,512),[[b,v.value.deploy_path]])]),e("div",Te,[e("div",Fe,[t[56]||(t[56]=e("label",{class:"label"},[e("span",{class:"label-text text-sm"},"证书文件名")],-1)),p(e("input",{"onUpdate:modelValue":t[21]||(t[21]=l=>v.value.file_mapping.cert=l),type:"text",class:"input input-bordered input-sm"},null,512),[[b,v.value.file_mapping.cert]])]),e("div",Ee,[t[57]||(t[57]=e("label",{class:"label"},[e("span",{class:"label-text text-sm"},"私钥文件名")],-1)),p(e("input",{"onUpdate:modelValue":t[22]||(t[22]=l=>v.value.file_mapping.key=l),type:"text",class:"input input-bordered input-sm"},null,512),[[b,v.value.file_mapping.key]])]),e("div",Ie,[t[58]||(t[58]=e("label",{class:"label"},[e("span",{class:"label-text text-sm"},"完整链文件名")],-1)),p(e("input",{"onUpdate:modelValue":t[23]||(t[23]=l=>v.value.file_mapping.fullchain=l),type:"text",class:"input input-bordered input-sm"},null,512),[[b,v.value.file_mapping.fullchain]])])]),e("div",je,[t[59]||(t[59]=e("label",{class:"label"},[e("span",{class:"label-text"},"重载命令")],-1)),p(e("input",{"onUpdate:modelValue":t[24]||(t[24]=l=>v.value.reload_cmd=l),type:"text",class:"input input-bordered w-full"},null,512),[[b,v.value.reload_cmd]])]),e("div",Ne,[e("button",{type:"button",class:"btn",onClick:t[25]||(t[25]=l=>g.value=null)},"取消"),e("button",{type:"submit",class:"btn btn-primary",disabled:T.value},[T.value?(i(),u("span",Re)):(i(),U(o(X),{key:1,class:"w-4 h-4"})),t[60]||(t[60]=c(" 保存 ",-1))],8,Be)])],32)]),e("form",Le,[e("button",{onClick:t[26]||(t[26]=l=>g.value=null)},"close")])],2),e("dialog",{class:_(["modal",y.value!==null&&"modal-open"])},[e("div",Pe,[e("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:t[27]||(t[27]=l=>y.value=null)},[d(o(A),{class:"w-4 h-4"})]),t[63]||(t[63]=e("h3",{class:"font-bold text-lg"},"确认删除",-1)),t[64]||(t[64]=e("p",{class:"py-4"},"确定要移除这个证书绑定吗？",-1)),e("div",ze,[e("button",{class:"btn",onClick:t[28]||(t[28]=l=>y.value=null)},"取消"),e("button",{class:"btn btn-error",disabled:F.value,onClick:nt},[F.value?(i(),u("span",Ke)):E("",!0),t[62]||(t[62]=c(" 删除 ",-1))],8,He)])]),e("form",We,[e("button",{onClick:t[29]||(t[29]=l=>y.value=null)},"close")])],2)]))}});export{nl as default};
