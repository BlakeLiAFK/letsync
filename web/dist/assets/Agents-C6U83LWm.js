import{d as O,r as a,l as K,o as P,c as r,a as s,f as A,b as o,i as m,e as n,p as g,t as v,F as q,n as X,w as G,g as R,A as S,h as M,z as D,x as H,s as J,q as Q,k as i}from"./index-FuMGBNr_.js";import{P as Y,T as Z}from"./trash-2-C3yPm7fe.js";import{R as tt}from"./refresh-cw-B5UK-0jM.js";import{T as B}from"./triangle-alert-1Rn6Vmyi.js";import{S as E}from"./server-CbUF9Ud5.js";import{X as N}from"./x-CSfYnYOr.js";import{C as st}from"./check-Ib64XTCh.js";import{C as et}from"./copy-CDy7s6v3.js";import{W as lt,a as nt,K as at}from"./wifi-Bi-8Pd7i.js";import{E as ot}from"./eye-tqEmvbwV.js";import"./createLucideIcon-DPGb8pea.js";const it={class:"space-y-4"},rt={class:"flex flex-col sm:flex-row gap-3 justify-between"},dt=["disabled"],ut={key:0,class:"alert alert-error"},ct={key:1,class:"flex justify-center py-12"},vt={key:2,class:"card bg-base-100 shadow-sm"},mt={class:"card-body items-center text-center py-12"},bt={class:"w-16 h-16 rounded-full bg-base-200 flex items-center justify-center mb-4"},pt={key:3,class:"space-y-3"},ft={class:"card-body p-4"},gt={class:"flex flex-col lg:flex-row lg:items-center gap-4"},xt={class:"flex-1 min-w-0"},wt={class:"flex items-center gap-2 mb-2"},yt={class:"font-semibold truncate"},_t={class:"flex flex-wrap gap-x-4 gap-y-1 text-sm text-base-content/60"},ht={class:"font-mono"},kt={class:"flex gap-2"},Ct=["disabled","onClick"],$t=["onClick"],At={class:"modal-box"},Dt={key:0,class:"alert alert-error text-sm"},Tt={class:"form-control"},Ut={class:"form-control"},Vt={class:"modal-action"},Mt=["disabled"],Nt={key:0,class:"loading loading-spinner loading-sm"},Rt={method:"dialog",class:"modal-backdrop"},St={class:"modal-box"},Bt={class:"alert alert-warning mb-4"},Et={class:"form-control"},It={class:"flex gap-2"},Lt=["value"],Wt={class:"mt-4 p-4 bg-base-200 rounded-lg"},jt={class:"text-xs overflow-x-auto"},zt={class:"modal-action"},Ft={method:"dialog",class:"modal-backdrop"},Ot={class:"modal-box"},Kt={class:"modal-action"},Pt=["disabled"],qt={key:0,class:"loading loading-spinner loading-sm"},Xt={method:"dialog",class:"modal-backdrop"},os=O({__name:"Agents",setup(Gt){const T=a([]),x=a(!0),b=a(""),p=a(!1),u=a({name:"",poll_interval:300}),k=a(!1),w=a(""),d=a(null),C=a(!1),$=a(null),f=a(!1),y=a(""),U=a(!1);async function _(){x.value=!0,b.value="";try{const{data:l}=await D.list();T.value=l||[]}catch(l){const t=l;b.value=t.message||"加载失败"}finally{x.value=!1}}function I(l){return l?new Date(l).toLocaleString("zh-CN"):"-"}function h(l,t){const c=Date.now(),e=t?new Date(t).getTime():0,V=c-e;return l==="online"||V<300*1e3?{icon:lt,class:"text-success",text:"在线"}:{icon:nt,class:"text-error",text:"离线"}}async function L(){if(w.value="",!u.value.name){w.value="请输入名称";return}k.value=!0;try{const{data:l}=await D.create({name:u.value.name,poll_interval:u.value.poll_interval});p.value=!1,u.value={name:"",poll_interval:300},y.value=l.connect_url||`${window.location.origin}/agent/${l.uuid}/${l.signature}`,f.value=!0,await _()}catch(l){const t=l;w.value=t.response?.data?.error?.message||"创建失败"}finally{k.value=!1}}async function W(){if(d.value){C.value=!0;try{await D.delete(d.value),d.value=null,await _()}catch(l){const t=l;b.value=t.response?.data?.error?.message||"删除失败",d.value=null}finally{C.value=!1}}}async function j(l){$.value=l;try{const{data:t}=await D.regenerate(l);y.value=t.connect_url||`${window.location.origin}/agent/${t.uuid}/${t.signature}`,f.value=!0,await _()}catch(t){const c=t;b.value=c.response?.data?.error?.message||"重置密钥失败"}finally{$.value=null}}function z(){navigator.clipboard.writeText(y.value),U.value=!0,setTimeout(()=>{U.value=!1},2e3)}const F=K(()=>[...T.value].sort((l,t)=>{const c=h(l.status,l.last_seen).text==="在线",e=h(t.status,t.last_seen).text==="在线";return c!==e?c?-1:1:new Date(t.created_at).getTime()-new Date(l.created_at).getTime()}));return P(_),(l,t)=>{const c=Q("router-link");return i(),r("div",it,[s("div",rt,[s("button",{class:"btn btn-primary",onClick:t[0]||(t[0]=e=>p.value=!0)},[o(n(Y),{class:"w-4 h-4"}),t[12]||(t[12]=m(" 添加 Agent ",-1))]),s("button",{class:"btn btn-ghost btn-sm",onClick:_,disabled:x.value},[o(n(tt),{class:g(["w-4 h-4",x.value&&"animate-spin"])},null,8,["class"]),t[13]||(t[13]=m(" 刷新 ",-1))],8,dt)]),b.value?(i(),r("div",ut,[o(n(B),{class:"w-5 h-5"}),s("span",null,v(b.value),1)])):A("",!0),x.value?(i(),r("div",ct,[...t[14]||(t[14]=[s("span",{class:"loading loading-spinner loading-lg"},null,-1)])])):T.value.length===0?(i(),r("div",vt,[s("div",mt,[s("div",bt,[o(n(E),{class:"w-8 h-8 text-base-content/40"})]),t[15]||(t[15]=s("h3",{class:"text-lg font-semibold"},"暂无 Agent",-1)),t[16]||(t[16]=s("p",{class:"text-base-content/60"},"点击上方按钮添加第一个 Agent",-1))])])):(i(),r("div",pt,[(i(!0),r(q,null,X(F.value,e=>(i(),r("div",{key:e.id,class:"card bg-base-100 shadow-sm hover:shadow-md transition-shadow"},[s("div",ft,[s("div",gt,[s("div",xt,[s("div",wt,[o(n(E),{class:"w-5 h-5 text-base-content/40"}),s("h3",yt,v(e.name),1),s("div",{class:g(["flex items-center gap-1 text-sm",h(e.status,e.last_seen).class])},[(i(),M(H(h(e.status,e.last_seen).icon),{class:"w-4 h-4"})),m(" "+v(h(e.status,e.last_seen).text),1)],2)]),s("div",_t,[s("span",ht,"UUID: "+v(e.uuid.slice(0,8))+"...",1),s("span",null,"轮询间隔: "+v(e.poll_interval)+"s",1),s("span",null,"最后上线: "+v(I(e.last_seen)),1)])]),s("div",kt,[o(c,{to:`/agents/${e.id}`,class:"btn btn-ghost btn-sm"},{default:J(()=>[o(n(ot),{class:"w-4 h-4"}),t[17]||(t[17]=m(" 详情 ",-1))]),_:1},8,["to"]),s("button",{class:"btn btn-ghost btn-sm",disabled:$.value===e.id,onClick:V=>j(e.id)},[o(n(at),{class:g(["w-4 h-4",$.value===e.id&&"animate-spin"])},null,8,["class"]),t[18]||(t[18]=m(" 重置密钥 ",-1))],8,Ct),s("button",{class:"btn btn-ghost btn-sm text-error",onClick:V=>d.value=e.id},[o(n(Z),{class:"w-4 h-4"})],8,$t)])])])]))),128))])),s("dialog",{class:g(["modal",p.value&&"modal-open"])},[s("div",At,[s("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:t[1]||(t[1]=e=>p.value=!1)},[o(n(N),{class:"w-4 h-4"})]),t[23]||(t[23]=s("h3",{class:"font-bold text-lg mb-4"},"添加 Agent",-1)),s("form",{onSubmit:G(L,["prevent"]),class:"space-y-4"},[w.value?(i(),r("div",Dt,v(w.value),1)):A("",!0),s("div",Tt,[t[19]||(t[19]=s("label",{class:"label"},[s("span",{class:"label-text"},"名称 *")],-1)),R(s("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>u.value.name=e),type:"text",class:"input input-bordered",placeholder:"例如: Web Server 01"},null,512),[[S,u.value.name]])]),s("div",Ut,[t[20]||(t[20]=s("label",{class:"label"},[s("span",{class:"label-text"},"轮询间隔 (秒)")],-1)),R(s("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>u.value.poll_interval=e),type:"number",class:"input input-bordered",min:"60",max:"86400"},null,512),[[S,u.value.poll_interval,void 0,{number:!0}]]),t[21]||(t[21]=s("label",{class:"label"},[s("span",{class:"label-text-alt"},"Agent 检查更新的频率，建议 300-600 秒")],-1))]),s("div",Vt,[s("button",{type:"button",class:"btn",onClick:t[4]||(t[4]=e=>p.value=!1)},"取消"),s("button",{type:"submit",class:"btn btn-primary",disabled:k.value},[k.value?(i(),r("span",Nt)):A("",!0),t[22]||(t[22]=m(" 创建 ",-1))],8,Mt)])],32)]),s("form",Rt,[s("button",{onClick:t[5]||(t[5]=e=>p.value=!1)},"close")])],2),s("dialog",{class:g(["modal",f.value&&"modal-open"])},[s("div",St,[s("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:t[6]||(t[6]=e=>f.value=!1)},[o(n(N),{class:"w-4 h-4"})]),t[27]||(t[27]=s("h3",{class:"font-bold text-lg mb-4"},"Agent 连接信息",-1)),s("div",Bt,[o(n(B),{class:"w-5 h-5"}),t[24]||(t[24]=s("span",null,"请妥善保管此连接 URL，关闭后将无法再次查看！",-1))]),s("div",Et,[t[25]||(t[25]=s("label",{class:"label"},[s("span",{class:"label-text"},"连接 URL")],-1)),s("div",It,[s("input",{value:y.value,type:"text",class:"input input-bordered flex-1 font-mono text-xs",readonly:""},null,8,Lt),s("button",{class:"btn btn-ghost",onClick:z},[U.value?(i(),M(n(st),{key:0,class:"w-5 h-5 text-success"})):(i(),M(n(et),{key:1,class:"w-5 h-5"}))])])]),s("div",Wt,[t[26]||(t[26]=s("p",{class:"text-sm font-medium mb-2"},"在目标服务器上运行:",-1)),s("pre",jt,'./letsync-agent -url "'+v(y.value)+'"',1)]),s("div",zt,[s("button",{class:"btn btn-primary",onClick:t[7]||(t[7]=e=>f.value=!1)},"我已保存")])]),s("form",Ft,[s("button",{onClick:t[8]||(t[8]=e=>f.value=!1)},"close")])],2),s("dialog",{class:g(["modal",d.value!==null&&"modal-open"])},[s("div",Ot,[s("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:t[9]||(t[9]=e=>d.value=null)},[o(n(N),{class:"w-4 h-4"})]),t[29]||(t[29]=s("h3",{class:"font-bold text-lg"},"确认删除",-1)),t[30]||(t[30]=s("p",{class:"py-4"},"确定要删除这个 Agent 吗？此操作不可恢复。",-1)),s("div",Kt,[s("button",{class:"btn",onClick:t[10]||(t[10]=e=>d.value=null)},"取消"),s("button",{class:"btn btn-error",disabled:C.value,onClick:W},[C.value?(i(),r("span",qt)):A("",!0),t[28]||(t[28]=m(" 删除 ",-1))],8,Pt)])]),s("form",Xt,[s("button",{onClick:t[11]||(t[11]=e=>d.value=null)},"close")])],2)])}}});export{os as default};
