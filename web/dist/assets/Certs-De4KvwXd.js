import{d as G,r as i,l as H,o as J,c as n,a as e,f as y,b as d,i as p,e as r,p as w,t as v,F as P,n as R,w as K,g as B,A as V,B as O,y as k,C as Q,q as W,k as l,h as M,x as Y,s as Z}from"./index-FuMGBNr_.js";import{P as ss,T as es}from"./trash-2-C3yPm7fe.js";import{R as ts}from"./refresh-cw-B5UK-0jM.js";import{T}from"./triangle-alert-1Rn6Vmyi.js";import{X as E}from"./x-CSfYnYOr.js";import{E as as}from"./eye-tqEmvbwV.js";import{c as ls}from"./createLucideIcon-DPGb8pea.js";import{R as ns}from"./rotate-ccw-Cpt0ZoDa.js";import{C as I}from"./clock-CWxjY3HO.js";import{C as os}from"./circle-x--W9BfU9X.js";import{C as is}from"./circle-check-big-C5mCHIra.js";const ds=ls("play",[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]]),rs={class:"space-y-4"},us={class:"flex flex-col sm:flex-row gap-3 justify-between"},cs=["disabled"],vs={key:0,class:"alert alert-error"},ms={key:1,class:"flex justify-center py-12"},ps={key:2,class:"card bg-base-100 shadow-sm"},bs={class:"card-body items-center text-center py-12"},gs={class:"w-16 h-16 rounded-full bg-base-200 flex items-center justify-center mb-4"},fs={key:3,class:"space-y-3"},ys={class:"card-body p-4"},xs={class:"flex flex-col lg:flex-row lg:items-center gap-4"},_s={class:"flex-1 min-w-0"},ws={class:"flex items-center gap-2 mb-2"},ks={class:"font-semibold truncate"},hs={class:"flex flex-wrap gap-x-4 gap-y-1 text-sm text-base-content/60"},Cs={key:0},Ds={key:1},Ns={class:"flex gap-2"},$s=["disabled","onClick"],Ss={key:1,class:"loading loading-spinner loading-sm"},Bs=["disabled","onClick"],Ts=["onClick"],As={class:"modal-box"},Ps={key:0,class:"alert alert-error text-sm"},Rs={class:"form-control"},Vs={class:"form-control"},Ms={class:"form-control"},Es=["value"],Is={class:"modal-action"},js=["disabled"],Ls={key:0,class:"loading loading-spinner loading-sm"},zs={method:"dialog",class:"modal-backdrop"},Fs={class:"modal-box"},Us={class:"modal-action"},Xs=["disabled"],qs={key:0,class:"loading loading-spinner loading-sm"},Gs={method:"dialog",class:"modal-backdrop"},le=G({__name:"Certs",setup(Hs){const $=i([]),A=i([]),x=i(!0),u=i(""),b=i(!1),o=i({domain:"",san:"",dns_provider_id:0}),h=i(!1),g=i(""),c=i(null),C=i(!1),D=i(null),N=i(null);async function f(){x.value=!0,u.value="";try{const[a,s]=await Promise.all([k.list(),Q.list()]);$.value=a.data||[],A.value=s.data||[]}catch(a){const s=a;u.value=s.message||"加载失败"}finally{x.value=!1}}function S(a){switch(a){case"valid":return{class:"badge-success",icon:is,text:"有效"};case"expiring":return{class:"badge-warning",icon:I,text:"即将过期"};case"expired":return{class:"badge-error",icon:os,text:"已过期"};case"pending":return{class:"badge-info",icon:I,text:"待申请"};default:return{class:"badge-ghost",icon:T,text:a}}}function j(a){return a?new Date(a).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}):"-"}function L(a){return a.dns_provider?.name||"-"}async function z(){if(g.value="",!o.value.domain){g.value="请输入域名";return}if(!o.value.dns_provider_id){g.value="请选择 DNS 提供商";return}h.value=!0;try{const a=o.value.san?o.value.san.split(",").map(s=>s.trim()).filter(Boolean):[];await k.create({domain:o.value.domain,san:a,dns_provider_id:o.value.dns_provider_id}),b.value=!1,o.value={domain:"",san:"",dns_provider_id:0},await f()}catch(a){const s=a;g.value=s.response?.data?.error?.message||"添加失败"}finally{h.value=!1}}async function F(){if(c.value){C.value=!0;try{await k.delete(c.value),c.value=null,await f()}catch(a){const s=a;u.value=s.response?.data?.error?.message||"删除失败",c.value=null}finally{C.value=!1}}}async function U(a){D.value=a,u.value="";try{await k.issue(a),await f()}catch(s){const m=s;u.value=m.response?.data?.error?.message||"申请失败"}finally{D.value=null}}async function X(a){N.value=a,u.value="";try{await k.renew(a),await f()}catch(s){const m=s;u.value=m.response?.data?.error?.message||"续期失败"}finally{N.value=null}}const q=H(()=>[...$.value].sort((a,s)=>{const m={pending:0,expired:1,expiring:2,valid:3},t=m[a.status]??4,_=m[s.status]??4;return t!==_?t-_:new Date(s.created_at).getTime()-new Date(a.created_at).getTime()}));return J(f),(a,s)=>{const m=W("router-link");return l(),n("div",rs,[e("div",us,[e("button",{class:"btn btn-primary",onClick:s[0]||(s[0]=t=>b.value=!0)},[d(r(ss),{class:"w-4 h-4"}),s[10]||(s[10]=p(" 添加证书 ",-1))]),e("button",{class:"btn btn-ghost btn-sm",onClick:f,disabled:x.value},[d(r(ts),{class:w(["w-4 h-4",x.value&&"animate-spin"])},null,8,["class"]),s[11]||(s[11]=p(" 刷新 ",-1))],8,cs)]),u.value?(l(),n("div",vs,[d(r(T),{class:"w-5 h-5"}),e("span",null,v(u.value),1)])):y("",!0),x.value?(l(),n("div",ms,[...s[12]||(s[12]=[e("span",{class:"loading loading-spinner loading-lg"},null,-1)])])):$.value.length===0?(l(),n("div",ps,[e("div",bs,[e("div",gs,[d(r(T),{class:"w-8 h-8 text-base-content/40"})]),s[13]||(s[13]=e("h3",{class:"text-lg font-semibold"},"暂无证书",-1)),s[14]||(s[14]=e("p",{class:"text-base-content/60"},"点击上方按钮添加第一个证书",-1))])])):(l(),n("div",fs,[(l(!0),n(P,null,R(q.value,t=>(l(),n("div",{key:t.id,class:"card bg-base-100 shadow-sm hover:shadow-md transition-shadow"},[e("div",ys,[e("div",xs,[e("div",_s,[e("div",ws,[e("h3",ks,v(t.domain),1),e("div",{class:w(["badge badge-sm gap-1",S(t.status).class])},[(l(),M(Y(S(t.status).icon),{class:"w-3 h-3"})),p(" "+v(S(t.status).text),1)],2)]),e("div",hs,[t.san&&t.san.length>0?(l(),n("span",Cs," SAN: "+v(t.san.join(", ")),1)):y("",!0),e("span",null,"DNS: "+v(L(t)),1),t.expires_at?(l(),n("span",Ds,"过期: "+v(j(t.expires_at)),1)):y("",!0)])]),e("div",Ns,[d(m,{to:`/certs/${t.id}`,class:"btn btn-ghost btn-sm"},{default:Z(()=>[d(r(as),{class:"w-4 h-4"}),s[15]||(s[15]=p(" 详情 ",-1))]),_:1},8,["to"]),t.status==="pending"?(l(),n("button",{key:0,class:"btn btn-primary btn-sm",disabled:D.value===t.id,onClick:_=>U(t.id)},[D.value!==t.id?(l(),M(r(ds),{key:0,class:"w-4 h-4"})):(l(),n("span",Ss)),s[16]||(s[16]=p(" 申请 ",-1))],8,$s)):(l(),n("button",{key:1,class:"btn btn-ghost btn-sm",disabled:N.value===t.id,onClick:_=>X(t.id)},[d(r(ns),{class:w(["w-4 h-4",N.value===t.id&&"animate-spin"])},null,8,["class"]),s[17]||(s[17]=p(" 续期 ",-1))],8,Bs)),e("button",{class:"btn btn-ghost btn-sm text-error",onClick:_=>c.value=t.id},[d(r(es),{class:"w-4 h-4"})],8,Ts)])])])]))),128))])),e("dialog",{class:w(["modal",b.value&&"modal-open"])},[e("div",As,[e("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:s[1]||(s[1]=t=>b.value=!1)},[d(r(E),{class:"w-4 h-4"})]),s[24]||(s[24]=e("h3",{class:"font-bold text-lg mb-4"},"添加证书",-1)),e("form",{onSubmit:K(z,["prevent"]),class:"space-y-4"},[g.value?(l(),n("div",Ps,v(g.value),1)):y("",!0),e("div",Rs,[s[18]||(s[18]=e("label",{class:"label"},[e("span",{class:"label-text"},"主域名 *")],-1)),B(e("input",{"onUpdate:modelValue":s[2]||(s[2]=t=>o.value.domain=t),type:"text",class:"input input-bordered",placeholder:"example.com"},null,512),[[V,o.value.domain]])]),e("div",Vs,[s[19]||(s[19]=e("label",{class:"label"},[e("span",{class:"label-text"},"SAN 域名"),e("span",{class:"label-text-alt"},"多个用逗号分隔")],-1)),B(e("input",{"onUpdate:modelValue":s[3]||(s[3]=t=>o.value.san=t),type:"text",class:"input input-bordered",placeholder:"www.example.com, api.example.com"},null,512),[[V,o.value.san]])]),e("div",Ms,[s[21]||(s[21]=e("label",{class:"label"},[e("span",{class:"label-text"},"DNS 提供商 *")],-1)),B(e("select",{"onUpdate:modelValue":s[4]||(s[4]=t=>o.value.dns_provider_id=t),class:"select select-bordered"},[s[20]||(s[20]=e("option",{value:0,disabled:""},"请选择",-1)),(l(!0),n(P,null,R(A.value,t=>(l(),n("option",{key:t.id,value:t.id},v(t.name)+" ("+v(t.type)+") ",9,Es))),128))],512),[[O,o.value.dns_provider_id]])]),s[23]||(s[23]=e("div",{class:"text-sm text-base-content/60 bg-base-200 p-3 rounded-lg"},[e("p",null,`添加后证书将处于"待申请"状态，你可以稍后点击"申请"按钮向 Let's Encrypt 申请证书。`)],-1)),e("div",Is,[e("button",{type:"button",class:"btn",onClick:s[5]||(s[5]=t=>b.value=!1)},"取消"),e("button",{type:"submit",class:"btn btn-primary",disabled:h.value},[h.value?(l(),n("span",Ls)):y("",!0),s[22]||(s[22]=p(" 添加 ",-1))],8,js)])],32)]),e("form",zs,[e("button",{onClick:s[6]||(s[6]=t=>b.value=!1)},"close")])],2),e("dialog",{class:w(["modal",c.value!==null&&"modal-open"])},[e("div",Fs,[e("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:s[7]||(s[7]=t=>c.value=null)},[d(r(E),{class:"w-4 h-4"})]),s[26]||(s[26]=e("h3",{class:"font-bold text-lg"},"确认删除",-1)),s[27]||(s[27]=e("p",{class:"py-4"},"确定要删除这个证书吗？此操作不可恢复。",-1)),e("div",Us,[e("button",{class:"btn",onClick:s[8]||(s[8]=t=>c.value=null)},"取消"),e("button",{class:"btn btn-error",disabled:C.value,onClick:F},[C.value?(l(),n("span",qs)):y("",!0),s[25]||(s[25]=p(" 删除 ",-1))],8,Xs)])]),e("form",Gs,[e("button",{onClick:s[9]||(s[9]=t=>c.value=null)},"close")])],2)])}}});export{le as default};
